const CACHE_NAME="storyshare-v4",OFFLINE_URL=BASE_URL+"index.html",API_URL="https://story-api.dicoding.dev",BASE_URL=self.location.origin+self.location.pathname.replace(/sw\.js$/,""),urlsToCache=[BASE_URL,BASE_URL+"index.html",BASE_URL+"manifest.json",BASE_URL+"favicon.png",BASE_URL+"app.bundle.js"];async function syncOfflineStories(){try{const e=await openDatabase(),t=await new Promise(((t,n)=>{const o=e.transaction("offline-stories","readonly").objectStore("offline-stories").getAll();o.onsuccess=()=>t(o.result),o.onerror=()=>n(o.error)}));if(0===t.length)return void console.log("[SW] Tidak ada cerita offline untuk disinkronkan.");console.log(`[SW] Menyinkronkan ${t.length} cerita...`);let n=0;for(const o of t)try{const t=await base64ToBlob(o.photoBase64,o.photoType),i=new FormData;i.append("description",o.description),i.append("photo",t,o.photoName),o.lat&&o.lon&&(i.append("lat",o.lat),i.append("lon",o.lon)),(await fetch(`${API_URL}/v1/stories`,{method:"POST",headers:{Authorization:`Bearer ${o.token}`},body:i})).ok&&(await deleteStoryFromDB(e,o.id),n++)}catch(e){console.error("[SW] Gagal upload story offline:",e)}n>0&&self.registration.showNotification("StoryShare",{body:`${n} cerita berhasil disinkronkan!`,icon:"./favicon.png",badge:"./favicon.png"})}catch(e){console.error("[SW] Gagal sinkronisasi offline:",e)}}function base64ToBlob(e,t){return fetch(e).then((e=>e.blob())).then((e=>new Blob([e],{type:t})))}function openDatabase(){return new Promise(((e,t)=>{const n=indexedDB.open("storyshare-db",1);n.onsuccess=()=>e(n.result),n.onerror=()=>t(n.error)}))}function deleteStoryFromDB(e,t){return new Promise(((n,o)=>{const i=e.transaction("offline-stories","readwrite").objectStore("offline-stories").delete(t);i.onsuccess=()=>n(),i.onerror=()=>o(i.error)}))}self.addEventListener("install",(e=>{console.log("[SW] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>e.addAll(urlsToCache))).then((()=>self.skipWaiting())))})),self.addEventListener("activate",(e=>{console.log("[SW] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("[SW] Deleting old cache:",e),caches.delete(e)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{const{request:t}=e;"GET"===t.method&&(t.url.startsWith(API_URL)?e.respondWith(fetch(t).then((e=>{const n=e.clone();return caches.open(CACHE_NAME).then((e=>e.put(t,n))),e})).catch((()=>caches.match(t)))):e.respondWith(caches.match(t).then((e=>e||fetch(t).then((e=>{if(e&&200===e.status){const n=e.clone();caches.open(CACHE_NAME).then((e=>e.put(t,n)))}return e})).catch((()=>"navigate"===t.mode?caches.match(OFFLINE_URL):new Response("Offline",{status:503})))))))})),self.addEventListener("push",(e=>{console.log("[SW] Push received");let t={};try{t=e.data.json()}catch(e){t={title:"StoryShare",body:"Ada cerita baru!"}}const n=t.title||"StoryShare",o={body:t.body||"Ada cerita baru yang menarik!",icon:"./favicon.png",badge:"./favicon.png",data:{url:t.url||"./"},actions:[{action:"open",title:"Lihat"},{action:"close",title:"Tutup"}]};e.waitUntil(self.registration.showNotification(n,o))})),self.addEventListener("notificationclick",(e=>{if(console.log("[SW] Notification clicked"),e.notification.close(),"close"===e.action)return;const t=e.notification.data?.url||"./";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const t of e)if(t.url.includes(self.registration.scope)&&"focus"in t)return t.focus();if(clients.openWindow)return clients.openWindow(t)})))})),self.addEventListener("sync",(e=>{console.log("[SW] Background sync triggered:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncOfflineStories())}));