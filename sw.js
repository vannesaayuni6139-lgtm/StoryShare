const CACHE_NAME="storyshare-v1",urlsToCache=["/","/index.html","/app.bundle.js","/favicon.png","https://unpkg.com/leaflet@1.9.4/dist/leaflet.css","https://unpkg.com/leaflet@1.9.4/dist/leaflet.js","https://fonts.googleapis.com/css2?family=Libertinus+Serif+Display&display=swap"];async function syncOfflineStories(){try{const e=await openDatabase(),o=await new Promise(((o,t)=>{const n=e.transaction("offline-stories","readonly").objectStore("offline-stories").getAll();n.onsuccess=()=>o(n.result),n.onerror=()=>t(n.error)}));if(0===o.length)return void console.log("[Service Worker] No offline stories to sync");console.log(`[Service Worker] Syncing ${o.length} offline stories`);let t=0;for(const n of o)try{const o=await base64ToBlob(n.photoBase64,n.photoType),i=new FormData;i.append("description",n.description),i.append("photo",o,n.photoName),n.lat&&n.lon&&(i.append("lat",n.lat),i.append("lon",n.lon));const r=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n.token}`},body:i});r.ok?(await new Promise(((o,t)=>{const i=e.transaction("offline-stories","readwrite").objectStore("offline-stories").delete(n.id);i.onsuccess=()=>o(),i.onerror=()=>t(i.error)})),console.log("[Service Worker] Story synced and removed:",n.id),t++):console.error("[Service Worker] Failed to sync story, server error:",r.status)}catch(e){console.error("[Service Worker] Failed to sync story:",e)}t>0&&self.registration.showNotification("StoryShare",{body:`${t} cerita berhasil disinkronkan!`,icon:"/favicon.png",badge:"/favicon.png"})}catch(e){console.error("[Service Worker] Error in sync:",e)}}function base64ToBlob(e,o){return fetch(e).then((e=>e.blob())).then((e=>new Blob([e],{type:o})))}function openDatabase(){return new Promise(((e,o)=>{const t=indexedDB.open("storyshare-db",1);t.onsuccess=()=>e(t.result),t.onerror=()=>o(t.error)}))}self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[Service Worker] Caching app shell"),e.addAll(urlsToCache)))).then((()=>self.skipWaiting())))})),self.addEventListener("activate",(e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("[Service Worker] Deleting old cache:",e),caches.delete(e)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{const{request:o}=e;"https://story-api.dicoding.dev"===new URL(o.url).origin?e.respondWith(fetch(o).then((e=>{const t=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(o,t)})),e})).catch((()=>caches.match(o)))):e.respondWith(caches.match(o).then((e=>e||fetch(o).then((e=>{if(!e||200!==e.status||"basic"!==e.type)return e;const t=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(o,t)})),e})))))})),self.addEventListener("push",(e=>{console.log("[Service Worker] Push received");let o={title:"StoryShare",body:"Ada update baru!",icon:"/favicon.png",badge:"/favicon.png",data:{}};if(e.data)try{const t=e.data.json();o={title:t.title||o.title,body:t.body||o.body,icon:t.icon||o.icon,badge:t.badge||o.badge,data:t.data||{},actions:t.actions||[{action:"open",title:"Lihat Cerita"},{action:"close",title:"Tutup"}]}}catch(e){console.error("[Service Worker] Error parsing notification data:",e)}e.waitUntil(self.registration.showNotification(o.title,{body:o.body,icon:o.icon,badge:o.badge,data:o.data,actions:o.actions}))})),self.addEventListener("notificationclick",(e=>{if(console.log("[Service Worker] Notification clicked:",e.action),e.notification.close(),"open"===e.action){const o=e.notification.data?.storyId,t=o?`/#/story/${o}`:"/";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const o of e)if(o.url.includes(self.location.origin)&&"focus"in o)return o.navigate(t),o.focus();if(clients.openWindow)return clients.openWindow(t)})))}})),self.addEventListener("sync",(e=>{console.log("[Service Worker] Background sync:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncOfflineStories())}));