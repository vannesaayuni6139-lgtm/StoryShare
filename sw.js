const CACHE_NAME="storyshare-v2",urlsToCache=["./","./index.html","./manifest.json","./favicon.png","./app.bundle.js"];async function syncOfflineStories(){try{const e=await openDatabase(),o=await new Promise(((o,t)=>{const n=e.transaction("offline-stories","readonly").objectStore("offline-stories").getAll();n.onsuccess=()=>o(n.result),n.onerror=()=>t(n.error)}));if(0===o.length)return void console.log("[Service Worker] No offline stories to sync");console.log(`[Service Worker] Syncing ${o.length} offline stories`);let t=0;for(const n of o)try{const o=await base64ToBlob(n.photoBase64,n.photoType),r=new FormData;r.append("description",n.description),r.append("photo",o,n.photoName),n.lat&&n.lon&&(r.append("lat",n.lat),r.append("lon",n.lon)),(await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n.token}`},body:r})).ok&&(await new Promise(((o,t)=>{const r=e.transaction("offline-stories","readwrite").objectStore("offline-stories").delete(n.id);r.onsuccess=()=>o(),r.onerror=()=>t(r.error)})),console.log("[Service Worker] Story synced:",n.id),t++)}catch(e){console.error("[Service Worker] Failed to sync story:",e)}t>0&&self.registration.showNotification("StoryShare",{body:`${t} cerita berhasil disinkronkan!`,icon:"./favicon.png",badge:"./favicon.png"})}catch(e){console.error("[Service Worker] Error in sync:",e)}}function base64ToBlob(e,o){return fetch(e).then((e=>e.blob())).then((e=>new Blob([e],{type:o})))}function openDatabase(){return new Promise(((e,o)=>{const t=indexedDB.open("storyshare-db",1);t.onsuccess=()=>e(t.result),t.onerror=()=>o(t.error)}))}self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[Service Worker] Caching app shell"),e.addAll(urlsToCache)))).then((()=>(console.log("[Service Worker] Install successful"),self.skipWaiting()))).catch((e=>{throw console.error("[Service Worker] Install failed:",e),e})))})),self.addEventListener("activate",(e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("[Service Worker] Deleting old cache:",e),caches.delete(e)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{const{request:o}=e;"GET"===o.method&&(o.url.includes("story-api.dicoding.dev")?e.respondWith(fetch(o).then((e=>{const t=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(o,t),console.log("[Service Worker] API cached:",o.url)})),e})).catch((()=>caches.match(o).then((e=>e?(console.log("[Service Worker] Serving from cache (OFFLINE):",o.url),e):new Response(JSON.stringify({error:!0,message:"Offline - Data tidak tersedia"}),{status:503,statusText:"Service Unavailable",headers:{"Content-Type":"application/json"}})))))):e.respondWith(caches.match(o).then((e=>e||fetch(o).then((e=>{if(!e||200!==e.status||"basic"!==e.type)return e;const t=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(o,t)})),e})).catch((()=>"document"===o.destination?caches.match("./index.html"):new Response("Offline",{status:503})))))))})),self.addEventListener("push",(e=>{console.log("[Service Worker] Push received");let o={title:"StoryShare",body:"Ada cerita baru!",icon:"./favicon.png",badge:"./favicon.png",data:{url:"./"}};if(e.data)try{const t=e.data.json();o={title:t.title||o.title,body:t.body||t.message||o.body,icon:t.icon||o.icon,badge:t.badge||o.badge,data:t.data||o.data,actions:[{action:"open",title:"Lihat"},{action:"close",title:"Tutup"}]}}catch(e){console.error("[Service Worker] Error parsing push data:",e)}e.waitUntil(self.registration.showNotification(o.title,o))})),self.addEventListener("notificationclick",(e=>{if(console.log("[Service Worker] Notification clicked"),e.notification.close(),"open"===e.action){const o=e.notification.data?.url||"./";e.waitUntil(clients.matchAll({type:"window",includeUncontrolled:!0}).then((e=>{for(const o of e)if(o.url.includes(self.registration.scope)&&"focus"in o)return o.focus();if(clients.openWindow)return clients.openWindow(o)})))}})),self.addEventListener("sync",(e=>{console.log("[Service Worker] Background sync:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncOfflineStories())}));