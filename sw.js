const CACHE_NAME="storyshare-v1",urlsToCache=["./","./index.html","./manifest.json","./favicon.png","./app.bundle.js"];async function syncOfflineStories(){try{const e=await openDatabase(),o=await new Promise(((o,t)=>{const n=e.transaction("offline-stories","readonly").objectStore("offline-stories").getAll();n.onsuccess=()=>o(n.result),n.onerror=()=>t(n.error)}));if(0===o.length)return void console.log("[Service Worker] No offline stories to sync");console.log(`[Service Worker] Syncing ${o.length} offline stories`);let t=0;for(const n of o)try{const o=await base64ToBlob(n.photoBase64,n.photoType),r=new FormData;r.append("description",n.description),r.append("photo",o,n.photoName),n.lat&&n.lon&&(r.append("lat",n.lat),r.append("lon",n.lon));const s=await fetch("https://story-api.dicoding.dev/v1/stories",{method:"POST",headers:{Authorization:`Bearer ${n.token}`},body:r});s.ok?(await new Promise(((o,t)=>{const r=e.transaction("offline-stories","readwrite").objectStore("offline-stories").delete(n.id);r.onsuccess=()=>o(),r.onerror=()=>t(r.error)})),console.log("[Service Worker] Story synced and removed:",n.id),t++):console.error("[Service Worker] Failed to sync story, server error:",s.status)}catch(e){console.error("[Service Worker] Failed to sync story:",e)}t>0&&self.registration.showNotification("StoryShare",{body:`${t} cerita berhasil disinkronkan!`,icon:"/favicon.png",badge:"/favicon.png"})}catch(e){console.error("[Service Worker] Error in sync:",e)}}function base64ToBlob(e,o){return fetch(e).then((e=>e.blob())).then((e=>new Blob([e],{type:o})))}function openDatabase(){return new Promise(((e,o)=>{const t=indexedDB.open("storyshare-db",1);t.onsuccess=()=>e(t.result),t.onerror=()=>o(t.error)}))}self.addEventListener("install",(e=>{console.log("[Service Worker] Installing..."),e.waitUntil(caches.open(CACHE_NAME).then((e=>(console.log("[Service Worker] Caching app shell"),e.addAll(urlsToCache)))).then((()=>(console.log("[Service Worker] Install successful"),self.skipWaiting()))).catch((e=>{throw console.error("[Service Worker] Install failed:",e),e})))})),self.addEventListener("activate",(e=>{console.log("[Service Worker] Activating..."),e.waitUntil(caches.keys().then((e=>Promise.all(e.map((e=>{if(e!==CACHE_NAME)return console.log("[Service Worker] Deleting old cache:",e),caches.delete(e)}))))).then((()=>self.clients.claim())))})),self.addEventListener("fetch",(e=>{const{request:o}=e;"GET"===o.method&&e.respondWith(caches.match(o).then((e=>e||fetch(o).then((e=>{if(!e||200!==e.status||"basic"!==e.type)return e;const t=e.clone();return caches.open(CACHE_NAME).then((e=>{e.put(o,t)})),e})).catch((()=>"document"===o.destination?caches.match("./index.html"):new Response("Offline",{status:503}))))))})),self.addEventListener("push",(e=>{console.log("[Service Worker] Push received");const o={title:"StoryShare",body:"Ada update baru!",icon:"./favicon.png",badge:"./favicon.png",data:{},actions:[{action:"open",title:"Lihat"},{action:"close",title:"Tutup"}]};if(e.data)try{const t=e.data.json();o.title=t.title||o.title,o.body=t.body||o.body,o.data=t.data||{}}catch(e){console.error("[Service Worker] Error parsing push data:",e)}e.waitUntil(self.registration.showNotification(o.title,o))})),self.addEventListener("notificationclick",(e=>{console.log("[Service Worker] Notification clicked"),e.notification.close(),"open"===e.action&&e.waitUntil(clients.matchAll().then((e=>e.length>0?e[0].focus():clients.openWindow("./"))))})),self.addEventListener("sync",(e=>{console.log("[Service Worker] Background sync:",e.tag),"sync-stories"===e.tag&&e.waitUntil(syncOfflineStories())}));